<div class="orders-container">
  <h2>My Orders</h2>

  @if (loading) {
    <div class="loading">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p>Loading your orders...</p>
    </div>
  }

  @if (!loading && error) {
    <div class="alert alert-danger">
      {{ error }}
      <button (click)="loadOrders()" class="btn btn-sm btn-outline-primary ms-2">
        Try Again
      </button>
    </div>
  }

  @if (!loading && !error && orders.length === 0) {
    <div class="empty-orders">
      <div class="empty-icon">
        <i class="bi bi-box-seam" style="font-size: 4rem; color: #ccc;"></i>
      </div>
      <h3>No orders yet</h3>
      <p class="text-muted">Start shopping to see your orders here!</p>
      <a routerLink="/products" class="btn btn-primary">
        <i class="bi bi-cart-plus me-2"></i> Browse Products
      </a>
    </div>
  }

  @if (!loading && !error && orders.length > 0) {
    <div class="orders-list">

      @if (selectedOrder) {
        <div class="modal-overlay" (click)="closeModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h5 class="modal-title">
                @if (selectedOrder.status === 'pending' || selectedOrder.status === 'preparing') {
                  <span>
                    <i class="bi bi-x-circle text-danger me-2"></i> Cancel Order
                  </span>
                }
                @if (selectedOrder.status === 'shipped' || selectedOrder.status === 'delivered') {
                  <span>
                    <i class="bi bi-arrow-return-left text-warning me-2"></i> Return Order
                  </span>
                }
              </h5>
              <button type="button" class="btn-close" (click)="closeModal()">x</button>
            </div>
            <div class="modal-body">
              @if (selectedOrder.status === 'pending' || selectedOrder.status === 'preparing') {
                <div>
                  <p><strong>Are you sure you want to cancel this order?</strong></p>
                  <p>Order #{{selectedOrder._id?.slice(-8)}} will be cancelled and removed from your orders list.</p>
                  <p>Stock will be returned to inventory.</p>
                </div>
              }

              @if (selectedOrder.status === 'shipped' || selectedOrder.status === 'delivered') {
                <div>
                  <p><strong>Are you sure you want to return this order?</strong></p>
                  <p>Order #{{selectedOrder._id?.slice(-8)}} return process will be initiated.</p>
                  <p>Stock will be returned to inventory upon receipt.</p>
                </div>
              }

              <div class="mb-3">
                <label class="form-label">Reason (optional):</label>
                <textarea
                  [(ngModel)]="cancelReason"
                  class="form-control"
                  rows="3"
                  placeholder="Please provide a reason for cancellation/return...">
                </textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="closeModal()">
                <i class="bi bi-x-lg me-1"></i> Cancel
              </button>
              <button type="button" class="btn btn-danger" (click)="confirmCancel()">
                <i class="bi bi-check-lg me-1"></i> Confirm
              </button>
            </div>
          </div>
        </div>
      }

      @if (editingOrder) {
        <div class="modal-overlay" (click)="cancelEdit()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-pencil-square text-primary me-2"></i> Edit Order Details
              </h5>
              <button type="button" class="btn-close" (click)="cancelEdit()">x</button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Phone Number:</label>
                <input
                  type="tel"
                  [(ngModel)]="newPhone"
                  class="form-control"
                  placeholder="01001234567">
              </div>
              <div class="mb-3">
                <label class="form-label">Address:</label>
                <textarea
                  [(ngModel)]="newAddress"
                  class="form-control"
                  rows="3"
                  placeholder="123 Main Street, City, Country">
                </textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                <i class="bi bi-x-lg me-1"></i> Cancel
              </button>
              <button type="button" class="btn btn-primary" (click)="saveOrder(editingOrder._id)">
                <i class="bi bi-save me-1"></i> Save Changes
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Edit Item Quantity Modal -->
      @if (editingItemId) {
        <div class="modal-overlay" (click)="cancelEdit()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h5 class="modal-title">
                <i class="bi bi-123 text-primary me-2"></i> Update Quantity
              </h5>
              <button type="button" class="btn-close" (click)="cancelEdit()">x</button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">New Quantity:</label>
                <div class="quantity-control">
                  <button class="btn btn-outline-secondary" (click)="newQuantity = max(1, newQuantity - 1)">
                    <i class="bi bi-dash"></i>
                    -
                  </button>
                  <input
                    type="number"
                    [(ngModel)]="newQuantity"
                    class="form-control text-center"
                    min="1"
                    style="width: 80px; display: inline-block;">
                  <button class="btn btn-outline-secondary" (click)="newQuantity = newQuantity + 1">
                    <i class="bi bi-plus"></i>
                    +
                  </button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
                Cancel
              </button>
              <button type="button" class="btn btn-primary" (click)="saveItemQuantity(editingOrder?._id || editingOrderId)">
                Update Quantity
              </button>
            </div>
          </div>
        </div>
      }

      <!-- Orders Cards -->
      @for (order of orders; track order._id) {
        <div class="order-card">
          <div class="order-header">
            <div class="order-info">
              <h4>
                <i class="bi bi-receipt me-2"></i>
                Order #{{ order._id?.slice(-8) || 'N/A' }}
              </h4>
              <div class="order-meta">
                <span class="order-date">
                  <i class="bi bi-calendar me-1"></i>
                  {{ formatDate(order.createdAt) }}
                </span>
                <span class="order-payment ms-3">
                  <i class="bi bi-credit-card me-1"></i>
                  {{ order.paymentMethod === 'cash' ? 'Cash on Delivery' : 'Card' }}
                </span>
              </div>
            </div>
            <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">
              {{ order.status | titlecase }}
            </span>
          </div>

          <div class="order-details">
            <!-- Shipping Info -->
            <div class="shipping-info mb-3">
              <h6><i class="bi bi-truck me-2"></i> Shipping To:</h6>
              <p class="mb-1">
                <i class="bi bi-telephone me-2"></i> {{ order.phone }}
              </p>
              <p class="mb-0">
                <i class="bi bi-geo-alt me-2"></i> {{ order.address }}
              </p>
            </div>

            <!-- Order Items -->
            <div class="order-items">
              <h6><i class="bi bi-cart me-2"></i> Items:</h6>
              <div class="item-list">
                @for (item of order.items; track item.product._id) {
                  <div class="order-item">
                    <div class="item-info">
                      <span class="item-name">
                        {{ item.product?.name || 'Product' }}
                      </span>
                      <span class="item-price">
                        ${{ (item.price || item.product?.price || 0) * item.quantity | number:'1.2-2' }}
                      </span>
                    </div>
                    <div class="item-controls">
                      <span class="item-quantity">
                        Quantity: {{ item.quantity }}
                        @if (canEdit(order)) {
                          <button class="btn btn-sm btn-outline-primary ms-2"
                                  (click)="startEditItem(order._id, item)">
                            <i class="bi bi-pencil-square"></i> Edit
                          </button>
                        }
                      </span>
                      @if (canEdit(order)) {
                        <button class="btn btn-sm btn-outline-danger"
                                (click)="removeItemFromOrder(order._id, item.product._id)">
                          <i class="bi bi-trash"></i> Remove
                        </button>
                      }
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
              <div class="summary-row">
                <span>Subtotal:</span>
                <span>${{ order.totalPrice | number:'1.2-2' }}</span>
              </div>
              <div class="summary-row">
                <span>Shipping:</span>
                <span>${{ (order.totalPrice * 0.01) | number:'1.2-2' }}</span>
              </div>
              <hr>
              <div class="summary-row total">
                <strong>Total:</strong>
                <strong>${{ (order.totalPrice + (order.totalPrice * 0.01)) | number:'1.2-2' }}</strong>
              </div>
            </div>
          </div>

          <!-- Order Actions -->
          <div class="order-actions">
            @if (canEdit(order)) {
              <button class="btn btn-outline-primary"
                      (click)="startEdit(order)">
                <i class="bi bi-pencil-square me-1"></i> Edit Details
              </button>
            }

            @if (order.status !== 'cancelled' && order.status !== 'returned') {
              <button class="btn btn-outline-danger"
                      (click)="showCancelModal(order)">
                @if (order.status === 'pending' || order.status === 'preparing') {
                  <span>
                    <i class="bi bi-x-circle me-1"></i> Cancel Order
                  </span>
                }
                @if (order.status === 'shipped' || order.status === 'delivered') {
                  <span>
                    <i class="bi bi-arrow-return-left me-1"></i> Return
                  </span>
                }
              </button>
            }

            @if (order.status === 'cancelled' || order.status === 'returned') {
              <div class="status-message">
                @if (order.status === 'cancelled') {
                  <span class="text-danger">
                    <i class="bi bi-x-circle me-1"></i> Cancelled on {{ formatDate(order.cancelledAt) }}
                  </span>
                }
                @if (order.status === 'returned') {
                  <span class="text-warning">
                    <i class="bi bi-arrow-return-left me-1"></i> Returned on {{ formatDate(order.cancelledAt) }}
                  </span>
                }
                @if (order.cancelReason) {
                  <div class="cancel-reason">
                    <small class="text-muted">Reason: {{ order.cancelReason }}</small>
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>
